<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
  <title>ë©”ì¸ í˜ì´ì§€ - Godot ê²Œì„</title>

  <style>
    /* ... (ìŠ¤íƒ€ì¼ ìƒëµ) ... */
    html, body { margin: 0; padding: 0; border: 0; width: 100%; height: 100%; }
    body { color: white; background-color: black; overflow: hidden; touch-action: none; }
    #canvas { display: block; width: 100vw; height: 100vh; }
    #status { position: absolute; left: 0; right: 0; top: 0; bottom: 0; background-color: #242424; display: flex; flex-direction: column; justify-content: center; align-items: center; visibility: hidden; z-index: 99; }
    #logout-container { position: absolute; top: 10px; right: 10px; z-index: 100; color: white; background: rgba(0, 0, 0, 0.5); padding: 5px 10px; border-radius: 5px; font-family: sans-serif; }
    #logout-container a { color: white; text-decoration: none; }
  </style>

  <link id="-gd-engine-icon" rel="icon" type="image/png" href="/godot-game/Poket_Money.icon.png" />

  <script>
    function locateFile(path) {
      return "/godot-game/" + path;
    }
  </script>

  <script src="/godot-game/Poket_Money.js"></script>

  <script th:inline="javascript">
    // Godot ëŸ°íƒ€ì„ì˜ ë‚´ë¶€ ë³€ìˆ˜ë¥¼ ê°•ì œë¡œ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ ê²½ë¡œ ë¬¸ì œë¥¼ í•´ê²° (ì¶”ê°€ëœ ê³µê²©ì  ìˆ˜ì •)
    if (typeof Godot !== 'undefined') {
      // ì´ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì—¬ Godotì´ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œë¥¼ '/godot-game/'ë¡œ ì¸ì‹í•˜ë„ë¡ ê°•ì œ
      Godot._scriptName = '/godot-game/Poket_Money.js';
    }
  </script>
</head>
<body>

<canvas id="canvas">
  Your browser does not support the canvas tag.
</canvas>

<noscript>
  Your browser does not support JavaScript.
</noscript>

<div id="status">
  <img id="status-splash" src="/godot-game/Poket_Money.png" alt="Loading..." style="max-height: 50vh;">
  <progress id="status-progress" style="display: none;"></progress>
  <div id="status-notice" style="color: white; margin-top: 20px;">ê²Œì„ ì—”ì§„ ë¡œë”© ì¤‘...</div>
</div>

<div id="logout-container">
  <a href="/">ë¡œê·¸ì•„ì›ƒ</a>
</div>

<script th:inline="javascript">
  const loggedInUser = [[${session.loggedInUserId}]];
  const customArgs = loggedInUser ? ['--user-id', loggedInUser] : [];

  console.log("Godot Args:", customArgs);

  const canvasElement = document.getElementById('canvas');
  const statusDiv = document.getElementById('status');
  const progressElement = document.getElementById('status-progress');

  if (typeof Engine === 'undefined') {
    console.error("Engine class is not defined. Poket_Money.js failed to load or execute.");
    statusDiv.style.visibility = 'visible';
    statusDiv.innerHTML = '<div style="color: red;">ê²Œì„ ì—”ì§„ (JS) ë¡œë“œ ì‹¤íŒ¨!</div>';
  } else {
    const engine = new Engine();

    if (typeof GODOT_CONFIG !== 'undefined') {
      GODOT_CONFIG.args = GODOT_CONFIG.args.concat(customArgs);
      // ğŸš¨ locateFile í•¨ìˆ˜ê°€ ì „ì—­ìœ¼ë¡œ ì •ì˜ë˜ì—ˆìœ¼ë¯€ë¡œ GODOT_CONFIGì—ëŠ” ê²½ë¡œ ì„¤ì •ì„ ë„£ì§€ ì•ŠìŠµë‹ˆë‹¤.
    }

    const customConfig = {
      executable: "Poket_Money",
      'GODOT_CUSTOM_ARGS': customArgs,
      canvasResizePolicy: 2,
      focusCanvas: true,
      canvas: canvasElement,
      serviceWorker: null,

      onProgress: function (current, total) {
        if (current > 0 && total > 0) {
          progressElement.value = current;
          progressElement.max = total;
          progressElement.style.display = 'block';
          statusDiv.style.visibility = 'visible';
        }
      }
    };

    engine.startGame(customConfig).then(function() {
      console.log("Godot Game Started successfully.");
      statusDiv.style.visibility = 'hidden';

    }).catch((error) => {
      console.error("Godot Engine Start Failed:", error);

      statusDiv.style.visibility = 'visible';
      statusDiv.innerHTML = '<div style="color: red; font-size: 1.2em;">ê²Œì„ ë¡œë“œ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ!</div>'
              + `<p style="color: white; margin-top: 10px;">${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>`;
    });
  }
</script>
</body>
</html>